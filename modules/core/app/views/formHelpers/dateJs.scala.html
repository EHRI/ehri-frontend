@()

<script src="@controllers.core.routes.Assets.at("js/bootstrap-datepicker.js")" type="text/javascript"></script>

<script>
    $(document).ready(function() {
        //Shared variables
        re = /(\w+)\.dates\[([0-9]+)\]/;
        re2 = /descriptions\[([0-9]+)\]\.(\w+)\.dates\[([0-9]+)\]/;
        var defaultStartView = "decade";
        //var defaultFormat = 'yyyy-mm-dd';

        //Callback functions
        function dateField(name, src) {

            regResults = re.exec(src);
            regResults2 = re2.exec(src);

            if(regResults2.length == 4) {
                precision = "descriptions[" + regResults2[1] + "]." + regResults2[2] + ".dates[" + regResults2[3] + "]." + name
                precision = "*[name='" + precision + "']";
            } else {
                precision = regResults[1] + ".dates[" + regResults[2] + "]." + name
                precision = "*[name='" + precision + "']";
            }
            return precision;
        }

        function defaultFormat(that, datepick) {
            if(datepick === false) {
                precision = that.val();
            } else {
                name = that.attr("name");
                precision = $(dateField("precision", name)).val();
            }

            switch (precision) {
                case 'month':
                case 'quarter':
                    precision = "yyyy-mm";
                    break;
                case 'year':
                case 'decade':
                    precision = "yyyy";
                    break;
                default:
                    precision = "yyyy-mm-dd";
                    break;
            }
            return precision || "yyyy-mm-dd";
        }

        function defaultMinViewMode(that, datepick) {
            if(datepick === false) {
                precision = that.val();
            } else {
                name = that.attr("name");
                precision = $(dateField("precision", name)).val();
            }


            switch (precision) {
                case 'month':
                case 'quarter':
                    precision = 1;
                    break;
                case 'year':
                case 'decade':
                    precision = 2;
                    break;
                default:
                    precision = 0;
                    break;
            }

            return precision || false;
        }

        function hasDatepicker(obj) {
            if(typeof obj.datepicker === "undefined") {
                return false;
            } else {
                return true;
            }
        }

        //jQuery Handler
        $(document).on("change", ".precision", function() {
            that = $(this);

            start = $(dateField("startDate", that.attr("name")));
            end = $(dateField("endDate", that.attr("name")));

            if(hasDatepicker(start)) { start.datepicker("remove"); }
            start.datepicker({
                startView: defaultStartView, 
                format: function() {
                    return defaultFormat(that, true);
                },
                minViewMode : function() {
                    return defaultMinViewMode(that, true);
                }
            });
            if(hasDatepicker(end)) { end.datepicker("remove"); }
            end.datepicker({
                startView: defaultStartView, 
                format: function() {
                    return defaultFormat(that, true);
                },
                minViewMode : function() {
                    return defaultMinViewMode(that, true);
                }
            });
        });
        
        $(document).on('click', 'input.datepicker', function () {
            that = $(this);
            that.datepicker({
                startView: defaultStartView, 
                format: function() {
                    return defaultFormat(that, true);
                },
                minViewMode : function() {
                    return defaultMinViewMode(that, false);
                }
            }).datepicker('show');
        });
    });
</script>
