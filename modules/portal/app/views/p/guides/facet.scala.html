@(items: utils.search.ItemPage[DocumentaryUnit], available: Map[String, List[AnyModel]], template: (GuidePage, (Guide, List[GuidePage])))(implicit userOpt: Option[UserProfile], request: RequestHeader, prefs: utils.SessionPrefs, globalConfig: global.GlobalConfig, lang: Lang, flash: Flash)

@import models.{GuidePage, Guide}

@js = {
    <script type="text/javascript" src="@controllers.portal.routes.Assets.versioned("js/portal-guide.js")"></script>
    <script type="text/javascript" src="@controllers.portal.routes.Assets.versioned("js/portal-guide-facet.js")"></script>
    <script src="@controllers.core.routes.Assets.versioned("select2/select2.js")"></script>

    @lang.language match {
            case "en" => {}
            case _ => {
             <script src="@controllers.core.routes.Assets.versioned("select2/select2_locale_" + lang.language +".js")"></script>
        }
    }
    <script type="text/javascript">
        $(".facet-selected").select2(),

        $(".facet-browse").select2({
            minimumInputLength: 0,
            multiple: true,
            ajax: {
                url: function() {
                    console.log($(this));
                    return $(this).attr("data-target");
                },
                dataType: 'json',
                quietMillis: 100,
                data: function (term, page) { // page is the one-based page number tracked by Select2
                    return {
                        q: term, //search term
                        page_limit: 10, // page size
                        page: page // page number
                    };
                },
                results: function (data, page) {
                    var more = (page * 10) < data.total, // whether or not there are more results available
                            items = data.items;

                    $.each(items, function(i, e) {
                        if(typeof e.childCount !== "undefined" && e.childCount > 0) {
                          items[i].children = []
                        }
                        if(e.links === 0) {
                           items[i].disabled = true;
                        }
                    })
                    // notice we return the value of more so Select2 knows if more results can be loaded
                    return {results: data.items, more: more};
                }
            },
            formatResult: function(item) {
                var original = item;
                if(typeof original.parent !== "undefined" && original.parent !== null) {
                return "<div title ='" + original.parent.name + " > " + original.name + "'>" + original.name + " ("+ original.links+")" + "</div>";
                }
                return "<div title ='" + original.name + "'>" + original.name + " ("+ original.links+")" + "</div>";
                //return item.name;
            },
            formatSelection: function(item) {
                return item.name
            },
            //dropdownCssClass: "bigdrop", // apply css that makes the dropdown taller
            escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
        });
    </script>
}

@selectTwo(pageName: String, content: String) = {
    <div class="facet-class">
        <h4 class="facet-label">@pageName</h4>
        <div class="facet-options">
            <select multiple style="width: 100%" name="kw[]" data-placeholder="@pageName" class="form-control facet-selected select2 autosubmit">
                <option></option>
                @available.get(content).map { listAvailable =>
                    @listAvailable.map{ f=>
                        <option value="@f.id">@f.toStringLang</option>
                    }
                }
            </select>
        </div>
    </div>
}

@facets = {
    @views.html.common.search.selectedFacets(items)
    <p><small>
        @if(available.isEmpty) {
            @Messages("portal.guides.facets.hierarchy")
        } else {
            @Messages("portal.guides.facets.available")
        }
    </small></p>
    @for(page <- template._2._2) {
        @if(page.layout != GuidePage.Layout.Markdown) {
            @if(!available.isEmpty){
                        @selectTwo(page.name, page.content)
            } else{
            <div class="facet-class">
                <h4 class="facet-label">@page.name</h4>
                <div class="facet-options">
                    <input type="text" style="width: 100%;" name="kw[]" data-placeholder="@page.name" data-target="@controllers.portal.routes.Guides.layoutRetrieval(template._2._1.path, page.path)" class="form-control select2 facet-browse autosubmit" />
                </div>
            </div>
            }
        }
    }
}


@p.layout.guideLayoutFacet(template, facets = facets, scripts = js) {
    <article>
        <header>
            <h1>@Messages("portal.guides.faceted")</h1>
            <h3>@Messages("pagination.displayingItems", items.page + 1, items.page + items.count, items.total)</h3>
        </header>
        <section>
            <section class="content-results">
                    @items.items.map { doc =>
                        @p.guides.doc.itemResult(doc, template._2._1.path)
                    }
            </section>
        </section>
        <footer>
                @common.pagination(items)
        </footer>
    </article>

}
