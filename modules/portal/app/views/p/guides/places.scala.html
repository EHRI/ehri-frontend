@(template: (GuidePage, (Guide, List[GuidePage])), page: utils.search.ItemPage[(Concept,utils.search.SearchHit)], params: utils.search.SearchParams)(implicit userOpt: Option[UserProfile], request: RequestHeader, prefs: utils.SessionPrefs, globalConfig: global.GlobalConfig, lang: Lang, flash: Flash)

@js = {
	<script type="text/javascript" src="@controllers.core.routes.Assets.versioned("js/lib/leaflet.js")"></script>
	<script type="text/javascript">
		/*
			Functions
		*/
		addMarker = function(data) {
			if(!$items[data.id]) {
				$items[data.id] = true;
				return L.marker([parseFloat(data.latitude),parseFloat(data.longitude)]).addTo($map).bindPopup('<b>'+ data.name + '</b>', {
					minWidth : 300
				})
			}
			return false;
		}

		addMarkerList = function(data) {
			var i = 0;
			while(data[i]) {
				if(data[i].latitude !== "None" && data[i].longitude !== "None") {
					bindMarker(addMarker(data[i]), data[i].id)
				}
				++i;
			}
		}

		bindMarker = function(marker, id) {
			if(marker) {
				marker.on("popupopen", function(elem) {
					$.get("http://localhost:9000/accesspoints/" + id + "/" + VIRTUAL_UNIT, function(data) {
						var links = [];
						$.each(data, function(index, link) {
							links.push('<li><a href="'+ jsRoutes.controllers.portal.Guides.browseDocument(GUIDE_PATH, link.id).url +'">'+ link.name+'</a></li>')
						})
						$(elem.popup._contentNode).html(
							$(elem.popup._contentNode).html() +
							'<ul>' +
							links.join(" ") +
							'<li><a href="'+ VIRTUAL_UNIT_ROUTE+ data.id + '">More...</a></li></ul>'
						)
					});
				})
			}
		}
		/*
			Variables
		*/
		var $map = L.map('map').setView([50.508174054149, 14.152353697237], 13),
			$items = {},
			$bounds = [],
			$originalMarkers = [];


		/*
			Initiate
		*/
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo($map);
		
		
		/*
			Movement loading
		*/
    	$map.on('moveend', function(e) {
    		$.get(
    			"@controllers.portal.routes.Guides.layoutRetrieval(template._2._1.path, template._1.path)", 
    			{ lat : $map.getCenter().lat, lng: $map.getCenter().lng }, 
    			function (data) { 
    				addMarkerList(data);

    			}, 
    			"json")
    	});

    	/*
    		<-- Specific data for the page
    	*/

		@page.items.map { case(item, hit) =>
			@item.model.descriptions.headOption.map { desc =>
				@if(desc.longitude.nonEmpty) {
					$originalMarkers.push(
						{
							id : "@item.id",
							latitude : @desc.latitude,
							longitude : @desc.longitude,
							name : "@item.toStringLang"
						}
					)
			    	$bounds.push([@desc.latitude, @desc.longitude])
		    	}
	    	}
    	}
    	/*
			--> Specific data for the page
    	*/
    	addMarkerList($originalMarkers)
    	$map.fitBounds($bounds);

	</script>
}
@css = {
    <link rel="stylesheet" media="screen" href="@controllers.portal.routes.Assets.versioned("css/lib/leaflet.css")">
}
@p.layout.guideLayout(template, js, css) {
	<article>
		<header>
			<form role="form" action="@controllers.portal.routes.Guides.layoutRetrieval(template._2._1.path, template._1.path)">
				<ul class="nav nav-pills nav-ehri nav-ehri-black nav-justified">
					<li><input class="nav-ehri nav-ehri-black nav-ehri-input" name="q" placeholder="Quick Search" /></li>
					<li><button type="submit" class="nav-ehri nav-ehri-black nav-ehri-input">Search</button></li>
				</ul>
			</form>
		</header>
		<section>
			<div id="map" style="height:400px;"></div>
		</section>
		<footer>
		</footer>
	</article>

}
