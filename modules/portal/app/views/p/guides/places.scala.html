@(template: (GuidePage, (Guide, List[GuidePage])), page: utils.search.ItemPage[(Concept,utils.search.SearchHit)], params: utils.search.SearchParams)(implicit userOpt: Option[UserProfile], request: RequestHeader, prefs: utils.SessionPrefs, globalConfig: global.GlobalConfig, lang: Lang, flash: Flash)

@js = {
	<script type="text/javascript" src="@controllers.core.routes.Assets.versioned("js/lib/leaflet.js")"></script>
	<script type="text/javascript">
		/*
			Functions
		*/
		addMarker = function(data) {
			if(!$items[data.id]) {
				L.marker([parseFloat(data.latitude), parseFloat(data.longitude)]).addTo($map).bindPopup(data.name)
				$items[data.id] = true;
			}
		}

		addMarkerList = function(data) {
			var i = 0;
			while(data[i]) {
				if(data[i].latitude !== "None" && data[i].longitude !== "None") {
					addMarker(data[i])
				}
				++i;
			}
		}
		/*
			Variables
		*/
		var $map = L.map('map').setView([50.508174054149, 14.152353697237], 13),
			$items = {},
			$bounds = [],
			$originalMarkers = [];


		/*
			Initiate
		*/
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo($map);
		
		
		/*
			Movement loading
		*/
    	$map.on('moveend', function(e) {
    		$.get(
    			"@controllers.portal.routes.Guides.layoutRetrieval(template._2._1.path, template._1.path)", 
    			{ lat : $map.getCenter().lat, lng: $map.getCenter().lng }, 
    			function (data) { addMarkerList(data) }, 
    			"json")
    	});

    	/*
    		<-- Specific data for the page
    	*/

		@page.items.map { case(item, hit) =>
			@item.model.descriptions.headOption.map { desc =>
				@if(desc.longitude.nonEmpty) {
					$originalMarkers.push(
						{
							id : "@item.id",
							latitude : @desc.latitude,
							longitude : @desc.longitude,
							name : "@item.toStringLang"
						}
					)
			    	$bounds.push([@desc.latitude, @desc.longitude])
		    	}
	    	}
    	}
    	/*
			--> Specific data for the page
    	*/
    	addMarkerList($originalMarkers)
    	$map.fitBounds($bounds);
	</script>
}
@css = {
    <link rel="stylesheet" media="screen" href="@controllers.portal.routes.Assets.versioned("css/lib/leaflet.css")">
}
@p.layout.guideLayout(template, js, css) {
	<article>
		<header>
			<form role="form" action="@controllers.portal.routes.Guides.layoutRetrieval(template._2._1.path, template._1.path)">
				<ul class="nav nav-pills nav-ehri nav-ehri-black nav-justified">
					<li><input class="nav-ehri nav-ehri-black nav-ehri-input" name="q" placeholder="Quick Search" /></li>
					<li><button type="submit" class="nav-ehri nav-ehri-black nav-ehri-input">Search</button></li>
				</ul>
			</form>
		</header>
		<section>
			<div id="map" style="height:400px;"></div>
		</section>
		<footer>
		</footer>
	</article>

}
