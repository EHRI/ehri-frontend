@(item: AnyModel, nodeId: String, valueOpt: Option[String], key: String)(implicit fieldPrefix: String, userOpt: Option[UserProfile], req: RequestHeader, globalConfig: global.GlobalConfig, lang: Lang, fieldAnnotations: Seq[Annotation])

@isOwnAnnotation(annotation: Annotation) = @{
    (for {
        user <- userOpt
        annotator <- annotation.user
    } yield annotator.id == user.id).getOrElse(false)
}

@defining(fieldAnnotations.filter(_.model.field==Some(key))) { anns =>

    @valueOpt.filterNot(_.isEmpty).map { value =>
        <div class="item-text-field" id="@nodeId-@key">
            <div class="item-text-field-header">
                <h4>@Messages(fieldPrefix + "." + key)</h4>
            </div>
            <div class="item-text-field-value">
                @Html(views.Helpers.renderMarkdown(value))
            </div>
            <div class="item-text-field-annotations">
                @if(!anns.isEmpty) {
                    <ul class="list-unstyled">
                    @for(ann <- anns) {
                        @defining(isOwnAnnotation(ann)) { mine =>
                            <li style="display: @{if(mine) "block" else "none"}">@p.common.annotationInline(ann, mine)</li>
                        }
                    }
                    </ul>
                }

                <a data-item="@item.id" data-did="@nodeId" data-field="@key" class="annotate-field"
                   href="@controllers.portal.routes.Portal.annotateField(item.id, nodeId, key)">
                    @Messages("portal.social.createFieldAnnotation")
                </a>
            </div>
        </div>
    }
}