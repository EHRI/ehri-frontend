@(scope: models.base.Holder[models.base.AnyModel], fonds: Option[models.base.AnyModel], form: Form[models.admin.IngestParams], action: Call, sync: Boolean = false)(implicit userOpt: Option[UserProfile], req: RequestHeader, globalConfig: global.GlobalConfig, messages: Messages, md: views.MarkdownRenderer, flash: Flash)

@import models.admin.IngestParams._
@implicitField = @{ views.html.helper.FieldConstructor(formHelpers.fieldTemplate.f) }

@views.html.admin.layout.adminLayout(Messages("ingest.header")) {
    @views.html.admin.common.breadcrumbs(scope +: fonds.toSeq)
    @common.mainContent {
        <script>
            $(function() {

                var stop = -1;

                function appendProgressMessage(msg, newline) {
                    newline =  typeof newline !== "undefined" ? newline : true;
                    var $elem = $("#update-progress");
                    var $inner = $elem.find("> pre");
                    if ($inner.length === 0) {
                        $inner = $("<pre></pre>");
                        $elem.append($inner);
                    }
                    $inner.append(msg.replace("\n", "<br/>") + (newline ? "<br/>" : ""));
                    $elem.show().scrollTop($inner.height());
                }

                function tick() {
                  appendProgressMessage(".", false);
                  stop = setTimeout(tick, 1000);
                }

                function setRunning($elem, run) {
                    $elem.attr("disabled", run).toggleClass("running", run);
                    if (run) {
                      tick();
                    } else {
                      clearInterval(stop);
                    }
                }

                console.log("running...");
              $("#ingest-form").submit(function () {
                  var formData = new FormData(this),
                          $submit = $(this).find("[type='submit']"),
                          $progress = $(this).find("#upload-progress");

                  // chunked response position...
                  var pos = -1;

                  $.ajax({
                      url: $(this).attr("action"),
                      type: 'POST',
                      data: formData,
                      async: true,
                      cache: false,
                      contentType: false,
                      processData: false,
                      xhr: function() {
                        var xhr = $.ajaxSettings.xhr();
                        xhr.onprogress = function() {
                            var text = xhr.responseText;
                            console.log(text);
                            appendProgressMessage(text.slice(pos + 1));
                            pos += text.length;
                        }
                        if (xhr.upload) {
                          xhr.upload.addEventListener("progress", function (e) {
                              var percent = (e.loaded / e.total) * 100;
                              $progress.css("width", percent.toString() + "%");
                              if (percent === 100) {
                                appendProgressMessage("Finished uploading data...")
                              }
                          });
                        }
                        return xhr;
                      },
                      beforeSend: function() {
                          setRunning($submit, true);
                      },
                      success: function (data) {
                          appendProgressMessage(JSON.stringify(data), true);
                      },
                      error: function (xhr, text) {
                        console.log(xhr, text)
                          appendProgressMessage(xhr.responseText);
                      },
                      complete: function() {
                          setRunning($submit, false);
                      }
                  });

                  return false;
              });
            });
        </script>

        @common.itemDetails {
            @defining("ingest") { implicit prefix =>
                @helper.form(action = action, 'enctype -> "multipart/form-data", 'class -> "validate-form form-horizontal", 'id -> "ingest-form") {
                    @formHelpers.csrfToken()
                    @formHelpers.hiddenInput(form(SCOPE).copy(value = Some(scope.id)))
                    @formHelpers.hiddenInput(form(FONDS).copy(value = fonds.map(_.id)))

                    <h2>@Messages("ingest.header")</h2>
                    @if(sync) {
                        <p class="alert alert-warning">
                            <strong>@Messages("ingest.sync.warning.note")</strong>: @Messages("ingest.sync.warning")
                        </p>
                    }

                    @defining(form("")) { f =>
                        <fieldset>
                            @formHelpers.checkbox(f, ALLOW_UPDATE)
                            @formHelpers.checkbox(f, TOLERANT)
                        </fieldset>

                        <fieldset>
                            @formHelpers.lineInput(f, HANDLER)
                            @formHelpers.lineInput(f, IMPORTER)
                            @formHelpers.fileInput(f, PROPERTIES_FILE)
                        </fieldset>

                        @if(sync) {
                            <fieldset>
                                @formHelpers.textInput(f, EXCLUDES)
                            </fieldset>
                        }

                        <fieldset>
                            @formHelpers.textInput(f, LOG, 'required -> true)
                            @formHelpers.fileInput(f, DATA_FILE, 'required -> true)
                        </fieldset>
                    }

                    @if(sync) {
                        <div class="form-group">
                            <label class="control-label text-danger" for="confirm">@Messages("ingest.sync.confirm")</label>
                            <div class="control-elements">
                                <input id="confirm" type="checkbox" required/>
                            </div>
                        </div>
                    }

                    <div class="form-actions">
                        <div class="form-group">
                            <input type="submit" class="btn btn-default progress-button" value="@Messages("ingest.submit")"/>
                        </div>
                    </div>
                    <div class="progress row">
                        <div class="progress-bar progress-bar-striped" id="upload-progress" role="progressbar"
                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                            <span class="sr-only">0% Complete</span>
                        </div>
                    </div>


                    <div id="update-progress"></div>
                }
            }
        }
    }
}