@(files: Seq[services.storage.FileStorage#File], item: Repository, f: play.api.data.Form[String], action: Call)(implicit userOpt: Option[UserProfile], req: RequestHeader, globalConfig: global.GlobalConfig, messages: Messages, md: views.MarkdownRenderer, prefs: utils.SessionPrefs, flash: Flash)

@script = {
    <script>
        jQuery(function($) {
          $(".add-file-field").on("click", function() {

          })
        })();
    </script>
}

@implicitField = @{ views.html.helper.FieldConstructor(formHelpers.fieldTemplate.f) }

@views.html.admin.layout.rightSidebar(Messages("repository.data"), breadcrumbs = views.html.admin.common.breadcrumbs(List(item))) {
    <div id="upload-files">
        @views.html.admin.repository.uploadDataList(files)
    </div>

    <h3>@Messages("repository.data.upload")</h3>
    @helper.form(action = action, 'enctype -> "multipart/form-data", 'id -> "upload-form") {
        @formHelpers.csrfToken()
        @formHelpers.globalErrors(f)

        @helper.inputFile(f("file"), '_label -> Messages("repository.data.upload.files"), 'multiple -> false)

        <div class="progress">
            <div id="upload-progress"
                style="width: 0%" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        @formHelpers.submitButton(Messages("repository.data.upload.submit"))
    }

    <script>
        jQuery(document).ready(function($) {

          function setProgress(percentComplete) {
              $('#upload-progress').css({
                  width: (percentComplete + "%")
              }).attr("aria-valuenow", percentComplete);
          }

          $("#upload-form").submit(function(e) {
            e.preventDefault();

            let thisUrl = "@action";
            let file = document.getElementById("file").files[0];
            let url = e.target.action + "?@play.filters.csrf.CSRF.getToken.map(t => s"${t.name}=${t.value}").getOrElse("")";

            console.log("XHR", url);

            fetch(url + "&fileName=" + file.name, {
                method: 'POST',
                headers: {
                  'Content-Type': file.type
                }
            }).then(r => r.json()).then( data => {
              console.log("URL: ", data.uri);
              setProgress(0);

              fetch(data.uri, {
                  method: "PUT",
                  mode: "cors",
                  body: file,
                  headers: {
                    'Content-Type': file.type
                  }
              }).then(r => {
                  setProgress(100);

                  fetch(thisUrl, {
                    headers: {
                      'X-Requested-With': 'XMLHTTPREQUEST'
                    }
                  }).then(r => r.text()).then(html => {
                      $("#upload-files").html(html);
                      setProgress(0);
                  });

              }).catch(err => {
                console.log(err);
              });
            });
          });
        });
    </script>
} {
}
