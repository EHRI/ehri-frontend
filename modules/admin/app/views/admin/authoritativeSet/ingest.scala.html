@(item: AuthoritativeSet, f: Form[models.admin.IngestTask], action: Call)(implicit userOpt: Option[UserProfile], req: RequestHeader, globalConfig: global.GlobalConfig, messages: Messages, md: views.MarkdownRenderer, flash: Flash)

@import models.admin.IngestTask._
@implicitField = @{ views.html.helper.FieldConstructor(formHelpers.fieldTemplate.f) }

@views.html.admin.layout.adminLayout(item.toStringLang) {
    @views.html.admin.common.breadcrumbs(Seq(item))
    @common.mainContent {
        <script>
            $(function() {

                function appendProgressMessage(msg) {
                    var $elem = $("#update-progress");
                    var $inner = $elem.find("> pre");
                    if ($inner.length === 0) {
                        $inner = $("<pre></pre>");
                        $elem.append($inner);
                    }
                    $inner.append(msg + "<br/>");
                    $elem.show().scrollTop($inner.height());
                }

                function setRunning($elem, run) {
                    $elem.attr("disabled", run).toggleClass("running", run);
                }

                console.log("running...");
              $("#ingest-form").submit(function () {
                  var formData = new FormData(this),
                          $submit = $(this).find("[type='submit']"),
                          $progress = $(this).find("#upload-progress");

                  $.ajax({
                      url: $(this).attr("action"),
                      type: 'POST',
                      data: formData,
                      async: true,
                      cache: false,
                      contentType: false,
                      processData: false,
                      xhr: function() {
                        var xhr = $.ajaxSettings.xhr();
                        if (xhr.upload) {
                          xhr.upload.addEventListener("progress", function (e) {
                              var percent = (e.loaded / e.total) * 100;
                              $progress.css("width", percent.toString() + "%");
                              if (percent === 100) {
                                appendProgressMessage("Finished uploading data...")
                              }
                          });
                        }
                        return xhr;
                      },
                      beforeSend: function() {
                          setRunning($submit, true);
                      },
                      success: function (data) {
                          appendProgressMessage(JSON.stringify(data));
                      },
                      error: function (xhr, text) {
                          appendProgressMessage(xhr.responseText);
                      },
                      complete: function() {
                          setRunning($submit, false);
                      }
                  });

                  return false;
              });
            });
        </script>

        @common.itemDetails {
            @defining("") { implicit prefix =>
                @helper.form(action = action, 'enctype -> "multipart/form-data", 'class -> "validate-form entity-form form-horizontal", 'id -> "ingest-form") {
                    @formHelpers.csrfToken()

                    <h2>@Messages("ingest.header")</h2>

                    @formHelpers.checkbox(f(""), ALLOW_UPDATE)
                    @formHelpers.checkbox(f(""), TOLERANT)
                    @formHelpers.textInput(f(""), LOG, 'required -> true)

                    @helper.inputFile(f(DATA_FILE), 'required -> true)

                    <div class="progress">
                        <div class="progress-bar progress-bar-striped" id="upload-progress" role="progressbar"
                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                            <span class="sr-only">0% Complete</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <div class="form-group">
                            <input type="submit" class="btn btn-default progress-button" value="@Messages("ingest.submit")"/>
                        </div>
                    </div>

                    <div id="update-progress"></div>
                }
            }
        }
    }
}